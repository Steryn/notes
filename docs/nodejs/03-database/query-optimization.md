# 查询优化

## 查询优化基础

查询优化是提高数据库查询性能的关键技术。通过优化查询语句和数据库结构，可以显著减少查询响应时间，提高系统整体性能。

## SQL查询优化

### 执行计划

执行计划是数据库引擎执行SQL语句的具体步骤。通过分析执行计划，可以了解查询的性能瓶颈。

在MySQL中，可以使用`EXPLAIN`关键字查看查询的执行计划：

```sql
EXPLAIN SELECT * FROM users WHERE age > 18;
```

### 索引优化

索引是提高查询性能的重要手段。合理使用索引可以大大加快数据检索速度。

#### 索引类型

1. **主键索引**：唯一标识表中每一行记录的索引
2. **唯一索引**：确保索引列的值唯一
3. **普通索引**：最基本的索引类型，没有任何限制
4. **复合索引**：在多个列上创建的索引
5. **全文索引**：用于全文搜索

#### 索引使用原则

1. 在经常用于查询条件的列上创建索引
2. 在经常用于连接的列上创建索引
3. 在经常用于排序的列上创建索引
4. 避免在索引列上使用函数或表达式
5. 注意索引的选择性，选择性高的列更适合创建索引

### 查询语句优化

#### 避免全表扫描

全表扫描是性能最差的查询方式之一。应通过以下方式避免：

1. 在WHERE子句中使用索引列
2. 避免在索引列上使用`!=`、`IS NULL`等操作符
3. 避免在索引列上使用`LIKE`通配符开头的查询

#### 优化JOIN操作

1. 确保JOIN列上有索引
2. 尽量减少JOIN的表数量
3. 使用适当的JOIN类型（INNER JOIN、LEFT JOIN等）

#### 子查询优化

尽量将子查询转换为JOIN操作，因为JOIN通常比子查询有更好的性能。

## MongoDB查询优化

### 查询分析

MongoDB提供了`explain()`方法来分析查询性能：

```javascript
db.users.find({age: {$gt: 18}}).explain("executionStats");
```

### 索引优化

在MongoDB中创建索引：

```javascript
// 创建单字段索引
db.users.createIndex({age: 1});

// 创建复合索引
db.users.createIndex({age: 1, name: 1});

// 创建文本索引
db.articles.createIndex({title: "text", content: "text"});
```

### 查询优化技巧

1. 使用投影查询只返回需要的字段
2. 使用合适的查询操作符
3. 避免在查询中使用正则表达式
4. 合理使用聚合管道

## 数据库设计优化

### 表结构设计

1. 合理的数据类型选择
2. 适当的字段长度
3. 避免过度范式化或反范式化

### 分表分库

当单表数据量过大时，可以考虑分表分库来提高查询性能：

1. 水平分表：按行分割数据
2. 垂直分表：按列分割数据

## 实践项目

在博客系统中优化查询性能：

1. 分析现有查询的执行计划
2. 为常用查询字段创建合适的索引
3. 优化慢查询语句
4. 监控查询性能变化
