# 05 - MongoDBç´¢å¼•ä¸æ€§èƒ½ä¼˜åŒ–

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- ç†è§£MongoDBç´¢å¼•çš„å·¥ä½œåŸç†
- æŒæ¡å„ç§ç´¢å¼•ç±»å‹çš„åˆ›å»ºå’Œä½¿ç”¨
- å­¦ä¼šç´¢å¼•æ€§èƒ½åˆ†æå’Œä¼˜åŒ–
- ç†Ÿæ‚‰ç´¢å¼•ç®¡ç†æœ€ä½³å®è·µ

## ğŸ“š ç´¢å¼•åŸºç¡€æ¦‚å¿µ

### 1. ä»€ä¹ˆæ˜¯ç´¢å¼•ï¼Ÿ

ç´¢å¼•æ˜¯æ•°æ®åº“ä¸­ç”¨äºæé«˜æŸ¥è¯¢æ€§èƒ½çš„æ•°æ®ç»“æ„ã€‚MongoDBä½¿ç”¨B-treeç´¢å¼•æ¥å¿«é€Ÿå®šä½æ–‡æ¡£ï¼Œç±»ä¼¼äºä¹¦ç±çš„ç›®å½•ã€‚

**ç´¢å¼•çš„ä½œç”¨ï¼š**

- ğŸš€ **æé«˜æŸ¥è¯¢é€Ÿåº¦** - é¿å…å…¨è¡¨æ‰«æ
- ğŸ“Š **æ”¯æŒæ’åº** - å¿«é€Ÿæ’åºç»“æœ
- ğŸ” **æ”¯æŒèŒƒå›´æŸ¥è¯¢** - é«˜æ•ˆçš„èŒƒå›´æ“ä½œ
- ğŸ¯ **å”¯ä¸€æ€§çº¦æŸ** - ç¡®ä¿æ•°æ®å”¯ä¸€æ€§

### 2. ç´¢å¼•ç±»å‹

| ç´¢å¼•ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|---------|------|------|
| å•å­—æ®µç´¢å¼• | å•ä¸ªå­—æ®µçš„ç´¢å¼• | `{ name: 1 }` |
| å¤åˆç´¢å¼• | å¤šä¸ªå­—æ®µçš„ç´¢å¼• | `{ name: 1, age: 1 }` |
| å¤šé”®ç´¢å¼• | æ•°ç»„å­—æ®µçš„ç´¢å¼• | `{ tags: 1 }` |
| æ–‡æœ¬ç´¢å¼• | å…¨æ–‡æœç´¢ç´¢å¼• | `{ title: "text" }` |
| åœ°ç†ç©ºé—´ç´¢å¼• | åœ°ç†ä½ç½®ç´¢å¼• | `{ location: "2dsphere" }` |
| å“ˆå¸Œç´¢å¼• | å“ˆå¸Œå€¼ç´¢å¼• | `{ _id: "hashed" }` |

## ğŸ”§ ç´¢å¼•æ“ä½œ

### 1. åˆ›å»ºç´¢å¼•

```javascript
// åˆ›å»ºå•å­—æ®µç´¢å¼•
db.users.createIndex({ name: 1 })

// åˆ›å»ºå¤åˆç´¢å¼•
db.users.createIndex({ city: 1, age: 1 })

// åˆ›å»ºé™åºç´¢å¼•
db.users.createIndex({ created_at: -1 })

// åˆ›å»ºå”¯ä¸€ç´¢å¼•
db.users.createIndex({ email: 1 }, { unique: true })

// åˆ›å»ºç¨€ç–ç´¢å¼•ï¼ˆè·³è¿‡nullå€¼ï¼‰
db.users.createIndex({ phone: 1 }, { sparse: true })

// åˆ›å»ºéƒ¨åˆ†ç´¢å¼•ï¼ˆåªå¯¹æ»¡è¶³æ¡ä»¶çš„æ–‡æ¡£å»ºç´¢å¼•ï¼‰
db.users.createIndex(
  { name: 1 },
  { partialFilterExpression: { age: { $gte: 18 } } }
)
```

### 2. ç´¢å¼•é€‰é¡¹

```javascript
// åå°åˆ›å»ºç´¢å¼•ï¼ˆä¸é˜»å¡å…¶ä»–æ“ä½œï¼‰
db.users.createIndex({ name: 1 }, { background: true })

// è®¾ç½®ç´¢å¼•åç§°
db.users.createIndex({ name: 1 }, { name: "user_name_index" })

// TTLç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ é™¤è¿‡æœŸæ–‡æ¡£ï¼‰
db.sessions.createIndex(
  { created_at: 1 },
  { expireAfterSeconds: 3600 }  // 1å°æ—¶åè¿‡æœŸ
)

// åˆ›å»ºæ–‡æœ¬ç´¢å¼•
db.articles.createIndex({
  title: "text",
  content: "text"
})

// åˆ›å»ºåœ°ç†ç©ºé—´ç´¢å¼•
db.locations.createIndex({ location: "2dsphere" })
```

### 3. æŸ¥çœ‹ç´¢å¼•

```javascript
// æŸ¥çœ‹é›†åˆçš„æ‰€æœ‰ç´¢å¼•
db.users.getIndexes()

// æŸ¥çœ‹ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯
db.users.aggregate([{ $indexStats: {} }])

// æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
db.users.find({ name: "å¼ ä¸‰" }).explain("executionStats")
```

### 4. åˆ é™¤ç´¢å¼•

```javascript
// åˆ é™¤æŒ‡å®šç´¢å¼•
db.users.dropIndex({ name: 1 })

// åˆ é™¤æŒ‡å®šåç§°çš„ç´¢å¼•
db.users.dropIndex("user_name_index")

// åˆ é™¤æ‰€æœ‰é_idç´¢å¼•
db.users.dropIndexes()
```

## ğŸ“Š ç´¢å¼•æ€§èƒ½åˆ†æ

### 1. æŸ¥è¯¢è®¡åˆ’åˆ†æ

```javascript
// åŸºæœ¬æŸ¥è¯¢è®¡åˆ’
db.users.find({ name: "å¼ ä¸‰" }).explain()

// è¯¦ç»†æ‰§è¡Œç»Ÿè®¡
db.users.find({ name: "å¼ ä¸‰" }).explain("executionStats")

// æŸ¥è¯¢è®¡åˆ’åˆ†æ
db.users.find({ name: "å¼ ä¸‰" }).explain("queryPlanner")
```

### 2. æ‰§è¡Œç»Ÿè®¡è§£è¯»

```javascript
// æ‰§è¡Œç»Ÿè®¡ç»“æœç¤ºä¾‹
{
  "executionStats": {
    "executionSuccess": true,
    "nReturned": 1,           // è¿”å›æ–‡æ¡£æ•°
    "executionTimeMillis": 0, // æ‰§è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    "totalKeysExamined": 1,   // æ£€æŸ¥çš„ç´¢å¼•é”®æ•°
    "totalDocsExamined": 1,   // æ£€æŸ¥çš„æ–‡æ¡£æ•°
    "stage": "IXSCAN",        // æ‰§è¡Œé˜¶æ®µ
    "indexName": "name_1"     // ä½¿ç”¨çš„ç´¢å¼•
  }
}
```

### 3. æ€§èƒ½ç›‘æ§

```javascript
// å¯ç”¨æ€§èƒ½åˆ†æ
db.setProfilingLevel(2, { slowms: 100 })

// æŸ¥çœ‹æ…¢æŸ¥è¯¢
db.system.profile.find().sort({ ts: -1 }).limit(5)

// åˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µ
db.users.aggregate([{ $indexStats: {} }])
```

## ğŸ¯ ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

### 1. å¤åˆç´¢å¼•ä¼˜åŒ–

```javascript
// åˆ›å»ºæµ‹è¯•æ•°æ®
db.orders.insertMany([
  { customer: "å¼ ä¸‰", product: "æ‰‹æœº", amount: 1000, date: new Date("2024-01-01") },
  { customer: "æå››", product: "ç”µè„‘", amount: 2000, date: new Date("2024-01-02") },
  { customer: "å¼ ä¸‰", product: "å¹³æ¿", amount: 800, date: new Date("2024-01-03") }
])

// åˆ›å»ºå¤åˆç´¢å¼•
db.orders.createIndex({ customer: 1, product: 1, date: 1 })

// ç´¢å¼•å‰ç¼€è§„åˆ™
// ä»¥ä¸‹æŸ¥è¯¢å¯ä»¥ä½¿ç”¨ç´¢å¼•ï¼š
db.orders.find({ customer: "å¼ ä¸‰" })
db.orders.find({ customer: "å¼ ä¸‰", product: "æ‰‹æœº" })
db.orders.find({ customer: "å¼ ä¸‰", product: "æ‰‹æœº", date: { $gte: new Date("2024-01-01") } })

// ä»¥ä¸‹æŸ¥è¯¢ä¸èƒ½ä½¿ç”¨ç´¢å¼•ï¼š
db.orders.find({ product: "æ‰‹æœº" })  // è·³è¿‡äº†customerå­—æ®µ
db.orders.find({ date: { $gte: new Date("2024-01-01") } })  // è·³è¿‡äº†å‰é¢çš„å­—æ®µ
```

### 2. ç´¢å¼•é€‰æ‹©æ€§ä¼˜åŒ–

```javascript
// é«˜é€‰æ‹©æ€§å­—æ®µæ”¾åœ¨å‰é¢
db.users.createIndex({ email: 1, name: 1 })  // emailé€‰æ‹©æ€§æ›´é«˜

// ç­‰å€¼æŸ¥è¯¢å­—æ®µæ”¾åœ¨èŒƒå›´æŸ¥è¯¢å­—æ®µå‰é¢
db.orders.createIndex({ status: 1, date: 1 })  // statusæ˜¯ç­‰å€¼æŸ¥è¯¢

// æ’åºå­—æ®µè€ƒè™‘
db.users.createIndex({ city: 1, age: 1, name: 1 })  // æ”¯æŒæŒ‰nameæ’åº
```

### 3. éƒ¨åˆ†ç´¢å¼•ä¼˜åŒ–

```javascript
// åªä¸ºæ´»è·ƒç”¨æˆ·åˆ›å»ºç´¢å¼•
db.users.createIndex(
  { name: 1 },
  { partialFilterExpression: { status: "active" } }
)

// åªä¸ºæœ‰é‚®ç®±çš„ç”¨æˆ·åˆ›å»ºç´¢å¼•
db.users.createIndex(
  { email: 1 },
  { partialFilterExpression: { email: { $exists: true } } }
)
```

## ğŸ” ç‰¹æ®Šç´¢å¼•ç±»å‹

### 1. æ–‡æœ¬ç´¢å¼•

```javascript
// åˆ›å»ºæ–‡æœ¬ç´¢å¼•
db.articles.createIndex({
  title: "text",
  content: "text",
  tags: "text"
})

// æ–‡æœ¬æœç´¢
db.articles.find({ $text: { $search: "MongoDB æ•™ç¨‹" } })

// æ–‡æœ¬æœç´¢é€‰é¡¹
db.articles.find({
  $text: {
    $search: "MongoDB æ•™ç¨‹",
    $caseSensitive: false,
    $diacriticSensitive: false
  }
})

// æ–‡æœ¬æœç´¢è¯„åˆ†
db.articles.find(
  { $text: { $search: "MongoDB" } },
  { score: { $meta: "textScore" } }
).sort({ score: { $meta: "textScore" } })
```

### 2. åœ°ç†ç©ºé—´ç´¢å¼•

```javascript
// åˆ›å»º2dsphereç´¢å¼•
db.locations.createIndex({ location: "2dsphere" })

// åœ°ç†ç©ºé—´æŸ¥è¯¢
db.locations.find({
  location: {
    $near: {
      $geometry: {
        type: "Point",
        coordinates: [116.3974, 39.9093]  // åŒ—äº¬åæ ‡
      },
      $maxDistance: 1000  // 1å…¬é‡Œå†…
    }
  }
})

// åœ°ç†ç©ºé—´èŒƒå›´æŸ¥è¯¢
db.locations.find({
  location: {
    $geoWithin: {
      $geometry: {
        type: "Polygon",
        coordinates: [[[116.3, 39.8], [116.5, 39.8], [116.5, 40.0], [116.3, 40.0], [116.3, 39.8]]]
      }
    }
  }
})
```

### 3. TTLç´¢å¼•

```javascript
// åˆ›å»ºTTLç´¢å¼•
db.sessions.createIndex(
  { created_at: 1 },
  { expireAfterSeconds: 3600 }  // 1å°æ—¶åè¿‡æœŸ
)

// æ’å…¥æµ‹è¯•æ•°æ®
db.sessions.insertOne({
  user_id: "123",
  session_data: "some data",
  created_at: new Date()
})

// æ–‡æ¡£ä¼šåœ¨1å°æ—¶åè‡ªåŠ¨åˆ é™¤
```

## ğŸ› ï¸ å®è·µç»ƒä¹ 

### ç»ƒä¹ 1ï¼šç´¢å¼•åˆ›å»ºå’Œä¼˜åŒ–

1. åˆ›å»ºç”¨æˆ·é›†åˆå¹¶æ’å…¥æµ‹è¯•æ•°æ®
2. ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•
3. åˆ›å»ºå¤åˆç´¢å¼•ä¼˜åŒ–å¤šæ¡ä»¶æŸ¥è¯¢
4. åˆ†ææŸ¥è¯¢æ€§èƒ½å¹¶ä¼˜åŒ–ç´¢å¼•
5. æµ‹è¯•ç´¢å¼•å¯¹å†™å…¥æ€§èƒ½çš„å½±å“

### ç»ƒä¹ 2ï¼šæ–‡æœ¬æœç´¢

1. åˆ›å»ºæ–‡ç« é›†åˆå¹¶æ’å…¥æµ‹è¯•æ•°æ®
2. åˆ›å»ºæ–‡æœ¬ç´¢å¼•
3. å®ç°å…¨æ–‡æœç´¢åŠŸèƒ½
4. ä¼˜åŒ–æœç´¢ç»“æœçš„æ’åº
5. å¤„ç†ä¸­æ–‡æœç´¢çš„ç‰¹æ®Šæƒ…å†µ

### ç»ƒä¹ 3ï¼šåœ°ç†ç©ºé—´æŸ¥è¯¢

1. åˆ›å»ºä½ç½®æ•°æ®é›†åˆ
2. åˆ›å»ºåœ°ç†ç©ºé—´ç´¢å¼•
3. å®ç°é™„è¿‘ä½ç½®æŸ¥è¯¢
4. å®ç°åœ°ç†èŒƒå›´æŸ¥è¯¢
5. è®¡ç®—åœ°ç†ä½ç½®è·ç¦»

## â“ å¸¸è§é—®é¢˜

### Q: å¦‚ä½•é€‰æ‹©ç´¢å¼•å­—æ®µçš„é¡ºåºï¼Ÿ

A: 1. ç­‰å€¼æŸ¥è¯¢å­—æ®µåœ¨å‰ 2. é«˜é€‰æ‹©æ€§å­—æ®µåœ¨å‰ 3. æ’åºå­—æ®µè€ƒè™‘åœ¨å†… 4. èŒƒå›´æŸ¥è¯¢å­—æ®µåœ¨å

### Q: ç´¢å¼•ä¼šå½±å“å†™å…¥æ€§èƒ½å—ï¼Ÿ

A: æ˜¯çš„ï¼Œæ¯ä¸ªç´¢å¼•éƒ½ä¼šå½±å“å†™å…¥æ€§èƒ½ã€‚éœ€è¦å¹³è¡¡è¯»å†™æ€§èƒ½ï¼Œåˆ é™¤ä¸å¿…è¦çš„ç´¢å¼•ã€‚

### Q: å¦‚ä½•åˆ¤æ–­ç´¢å¼•æ˜¯å¦è¢«ä½¿ç”¨ï¼Ÿ

A: ä½¿ç”¨explain()æ–¹æ³•åˆ†ææŸ¥è¯¢è®¡åˆ’ï¼ŒæŸ¥çœ‹æ˜¯å¦ä½¿ç”¨äº†IXSCANé˜¶æ®µã€‚

### Q: å¤åˆç´¢å¼•çš„å‰ç¼€è§„åˆ™æ˜¯ä»€ä¹ˆï¼Ÿ

A: å¤åˆç´¢å¼•åªèƒ½ä½¿ç”¨ä»å·¦åˆ°å³çš„è¿ç»­å­—æ®µï¼Œä¸èƒ½è·³è¿‡ä¸­é—´çš„å­—æ®µã€‚

### Q: å¦‚ä½•ä¼˜åŒ–ç´¢å¼•å¤§å°ï¼Ÿ

A: ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•ã€ç¨€ç–ç´¢å¼•ï¼Œåˆ é™¤ä¸å¿…è¦çš„ç´¢å¼•ï¼Œå®šæœŸåˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µã€‚

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç´¢å¼•ç»´æŠ¤æˆæœ¬** - æ¯ä¸ªç´¢å¼•éƒ½ä¼šå ç”¨å­˜å‚¨ç©ºé—´å’Œå½±å“å†™å…¥æ€§èƒ½
2. **ç´¢å¼•é€‰æ‹©** - ä¸è¦ä¸ºæ‰€æœ‰å­—æ®µåˆ›å»ºç´¢å¼•ï¼Œåªåˆ›å»ºå¿…è¦çš„ç´¢å¼•
3. **å¤åˆç´¢å¼•é¡ºåº** - å­—æ®µé¡ºåºå¾ˆé‡è¦ï¼Œå½±å“æŸ¥è¯¢æ•ˆç‡
4. **ç´¢å¼•ç›‘æ§** - å®šæœŸç›‘æ§ç´¢å¼•ä½¿ç”¨æƒ…å†µï¼Œåˆ é™¤æœªä½¿ç”¨çš„ç´¢å¼•
5. **å†…å­˜ä½¿ç”¨** - ç´¢å¼•ä¼šå ç”¨å†…å­˜ï¼Œæ³¨æ„å†…å­˜ä½¿ç”¨æƒ…å†µ

## ğŸ¯ å­¦ä¹ æ£€æŸ¥

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] åˆ›å»ºå’Œç®¡ç†å„ç§ç±»å‹çš„ç´¢å¼•
- [ ] åˆ†ææŸ¥è¯¢æ€§èƒ½å¹¶ä¼˜åŒ–ç´¢å¼•
- [ ] ä½¿ç”¨æ–‡æœ¬ç´¢å¼•è¿›è¡Œå…¨æ–‡æœç´¢
- [ ] ä½¿ç”¨åœ°ç†ç©ºé—´ç´¢å¼•è¿›è¡Œä½ç½®æŸ¥è¯¢
- [ ] åº”ç”¨ç´¢å¼•ä¼˜åŒ–æœ€ä½³å®è·µ

---

**ä¸‹ä¸€æ­¥ï¼š** å­¦ä¹  [06-aggregation](./06-aggregation.md) èšåˆç®¡é“
