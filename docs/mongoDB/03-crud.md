# 03 - MongoDBåŸºæœ¬CRUDæ“ä½œ

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- æŒæ¡MongoDBçš„åŸºæœ¬CRUDæ“ä½œ
- ç†è§£æ–‡æ¡£çš„åˆ›å»ºã€è¯»å–ã€æ›´æ–°å’Œåˆ é™¤
- å­¦ä¼šä½¿ç”¨MongoDB Shellè¿›è¡Œæ•°æ®æ“ä½œ
- ç†Ÿæ‚‰å¸¸ç”¨çš„æŸ¥è¯¢å’Œæ›´æ–°æ–¹æ³•

## ğŸ“ CRUDæ“ä½œæ¦‚è¿°

CRUDä»£è¡¨å››ç§åŸºæœ¬æ•°æ®åº“æ“ä½œï¼š

- **C**reate - åˆ›å»ºæ–‡æ¡£
- **R**ead - è¯»å–æ–‡æ¡£
- **U**pdate - æ›´æ–°æ–‡æ¡£
- **D**elete - åˆ é™¤æ–‡æ¡£

## ğŸ†• Create - åˆ›å»ºæ“ä½œ

### 1. æ’å…¥å•ä¸ªæ–‡æ¡£

```javascript
// ä½¿ç”¨ insertOne() æ’å…¥å•ä¸ªæ–‡æ¡£
db.users.insertOne({
  name: "å¼ ä¸‰",
  age: 25,
  email: "zhangsan@example.com",
  city: "åŒ—äº¬"
})

// è¿”å›ç»“æœ
{
  acknowledged: true,
  insertedId: ObjectId("507f1f77bcf86cd799439011")
}
```

### 2. æ’å…¥å¤šä¸ªæ–‡æ¡£

```javascript
// ä½¿ç”¨ insertMany() æ’å…¥å¤šä¸ªæ–‡æ¡£
db.users.insertMany([
  {
    name: "æå››",
    age: 30,
    email: "lisi@example.com",
    city: "ä¸Šæµ·"
  },
  {
    name: "ç‹äº”",
    age: 28,
    email: "wangwu@example.com",
    city: "å¹¿å·"
  }
])

// è¿”å›ç»“æœ
{
  acknowledged: true,
  insertedIds: [
    ObjectId("507f1f77bcf86cd799439012"),
    ObjectId("507f1f77bcf86cd799439013")
  ]
}
```

### 3. æ’å…¥é€‰é¡¹

```javascript
// ä½¿ç”¨ ordered: false å…è®¸éƒ¨åˆ†æ’å…¥å¤±è´¥
db.users.insertMany([
  { name: "ç”¨æˆ·1" },
  { name: "ç”¨æˆ·2" },
  { _id: "duplicate_id" },  // é‡å¤ID
  { name: "ç”¨æˆ·3" }
], { ordered: false })

// ä½¿ç”¨ writeConcern æ§åˆ¶å†™å…¥ç¡®è®¤çº§åˆ«
db.users.insertOne(
  { name: "ç”¨æˆ·4" },
  { writeConcern: { w: "majority", j: true } }
)
```

## ğŸ“– Read - è¯»å–æ“ä½œ

### 1. æŸ¥è¯¢æ‰€æœ‰æ–‡æ¡£

```javascript
// æŸ¥è¯¢é›†åˆä¸­æ‰€æœ‰æ–‡æ¡£
db.users.find()

// æ ¼å¼åŒ–è¾“å‡º
db.users.find().pretty()
```

### 2. æ¡ä»¶æŸ¥è¯¢

```javascript
// ç­‰å€¼æŸ¥è¯¢
db.users.find({ age: 25 })

// æ¯”è¾ƒæŸ¥è¯¢
db.users.find({ age: { $gt: 25 } })        // å¤§äº25
db.users.find({ age: { $gte: 25 } })       // å¤§äºç­‰äº25
db.users.find({ age: { $lt: 30 } })        // å°äº30
db.users.find({ age: { $lte: 30 } })       // å°äºç­‰äº30
db.users.find({ age: { $ne: 25 } })        // ä¸ç­‰äº25
db.users.find({ age: { $in: [25, 30] } })  // åœ¨æ•°ç»„ä¸­
db.users.find({ age: { $nin: [25, 30] } }) // ä¸åœ¨æ•°ç»„ä¸­
```

### 3. é€»è¾‘æŸ¥è¯¢

```javascript
// AND æŸ¥è¯¢
db.users.find({ age: { $gt: 20 }, city: "åŒ—äº¬" })

// OR æŸ¥è¯¢
db.users.find({ $or: [
  { age: { $lt: 25 } },
  { city: "ä¸Šæµ·" }
]})

// NOT æŸ¥è¯¢
db.users.find({ age: { $not: { $gt: 25 } } })

// NOR æŸ¥è¯¢
db.users.find({ $nor: [
  { age: { $lt: 25 } },
  { city: "ä¸Šæµ·" }
]})
```

### 4. æ•°ç»„æŸ¥è¯¢

```javascript
// æ’å…¥åŒ…å«æ•°ç»„çš„æ–‡æ¡£
db.users.insertOne({
  name: "èµµå…­",
  hobbies: ["è¯»ä¹¦", "æ¸¸æ³³", "ç¼–ç¨‹"],
  scores: [85, 90, 78]
})

// æŸ¥è¯¢åŒ…å«ç‰¹å®šå…ƒç´ çš„æ•°ç»„
db.users.find({ hobbies: "ç¼–ç¨‹" })

// æŸ¥è¯¢æ•°ç»„é•¿åº¦
db.users.find({ hobbies: { $size: 3 } })

// æŸ¥è¯¢æ•°ç»„ä¸­çš„ç‰¹å®šä½ç½®
db.users.find({ "hobbies.0": "è¯»ä¹¦" })

// æŸ¥è¯¢æ»¡è¶³æ¡ä»¶çš„æ•°ç»„å…ƒç´ 
db.users.find({ scores: { $elemMatch: { $gt: 80 } } })
```

### 5. åµŒå¥—æ–‡æ¡£æŸ¥è¯¢

```javascript
// æ’å…¥åµŒå¥—æ–‡æ¡£
db.users.insertOne({
  name: "é’±ä¸ƒ",
  address: {
    city: "æ·±åœ³",
    district: "å—å±±åŒº",
    street: "ç§‘æŠ€å›­"
  }
})

// æŸ¥è¯¢åµŒå¥—å­—æ®µ
db.users.find({ "address.city": "æ·±åœ³" })

// æŸ¥è¯¢åµŒå¥—å¯¹è±¡
db.users.find({ address: { city: "æ·±åœ³", district: "å—å±±åŒº" } })
```

### 6. æŠ•å½±å’Œé™åˆ¶

```javascript
// æŠ•å½± - åªè¿”å›æŒ‡å®šå­—æ®µ
db.users.find({}, { name: 1, age: 1 })  // åªè¿”å›nameå’Œage
db.users.find({}, { name: 1, _id: 0 })  // è¿”å›nameï¼Œæ’é™¤_id

// é™åˆ¶ç»“æœæ•°é‡
db.users.find().limit(5)

// è·³è¿‡æ–‡æ¡£
db.users.find().skip(10)

// æ’åº
db.users.find().sort({ age: 1 })   // å‡åº
db.users.find().sort({ age: -1 })  // é™åº

// ç»„åˆä½¿ç”¨
db.users.find()
  .sort({ age: -1 })
  .limit(5)
  .skip(10)
```

### 7. æŸ¥è¯¢å•ä¸ªæ–‡æ¡£

```javascript
// æŸ¥è¯¢ç¬¬ä¸€ä¸ªåŒ¹é…çš„æ–‡æ¡£
db.users.findOne({ age: { $gt: 25 } })

// æŸ¥è¯¢å¹¶è®¡æ•°
db.users.countDocuments({ age: { $gt: 25 } })
```

## ğŸ”„ Update - æ›´æ–°æ“ä½œ

### 1. æ›´æ–°å•ä¸ªæ–‡æ¡£

```javascript
// ä½¿ç”¨ updateOne() æ›´æ–°å•ä¸ªæ–‡æ¡£
db.users.updateOne(
  { name: "å¼ ä¸‰" },                    // æŸ¥è¯¢æ¡ä»¶
  { $set: { age: 26, city: "ä¸Šæµ·" } }  // æ›´æ–°æ“ä½œ
)

// è¿”å›ç»“æœ
{
  acknowledged: true,
  matchedCount: 1,
  modifiedCount: 1
}
```

### 2. æ›´æ–°å¤šä¸ªæ–‡æ¡£

```javascript
// ä½¿ç”¨ updateMany() æ›´æ–°å¤šä¸ªæ–‡æ¡£
db.users.updateMany(
  { age: { $lt: 30 } },              // æŸ¥è¯¢æ¡ä»¶
  { $set: { status: "young" } }       // æ›´æ–°æ“ä½œ
)
```

### 3. æ›¿æ¢æ–‡æ¡£

```javascript
// ä½¿ç”¨ replaceOne() æ›¿æ¢æ•´ä¸ªæ–‡æ¡£
db.users.replaceOne(
  { name: "å¼ ä¸‰" },
  {
    name: "å¼ ä¸‰",
    age: 26,
    email: "zhangsan@example.com",
    city: "ä¸Šæµ·",
    status: "active"
  }
)
```

### 4. æ›´æ–°æ“ä½œç¬¦

```javascript
// $set - è®¾ç½®å­—æ®µå€¼
db.users.updateOne(
  { name: "å¼ ä¸‰" },
  { $set: { age: 26, city: "ä¸Šæµ·" } }
)

// $unset - åˆ é™¤å­—æ®µ
db.users.updateOne(
  { name: "å¼ ä¸‰" },
  { $unset: { status: "" } }
)

// $inc - å¢åŠ æ•°å€¼
db.users.updateOne(
  { name: "å¼ ä¸‰" },
  { $inc: { age: 1 } }
)

// $mul - ä¹˜ä»¥æ•°å€¼
db.users.updateOne(
  { name: "å¼ ä¸‰" },
  { $mul: { age: 1.1 } }
)

// $push - å‘æ•°ç»„æ·»åŠ å…ƒç´ 
db.users.updateOne(
  { name: "å¼ ä¸‰" },
  { $push: { hobbies: "è·‘æ­¥" } }
)

// $pull - ä»æ•°ç»„åˆ é™¤å…ƒç´ 
db.users.updateOne(
  { name: "å¼ ä¸‰" },
  { $pull: { hobbies: "è·‘æ­¥" } }
)

// $addToSet - å‘æ•°ç»„æ·»åŠ å”¯ä¸€å…ƒç´ 
db.users.updateOne(
  { name: "å¼ ä¸‰" },
  { $addToSet: { hobbies: "æ¸¸æ³³" } }
)

// $pop - åˆ é™¤æ•°ç»„é¦–å°¾å…ƒç´ 
db.users.updateOne(
  { name: "å¼ ä¸‰" },
  { $pop: { hobbies: 1 } }  // 1åˆ é™¤æœ€åä¸€ä¸ªï¼Œ-1åˆ é™¤ç¬¬ä¸€ä¸ª
)
```

### 5. æ•°ç»„æ›´æ–°æ“ä½œ

```javascript
// æ›´æ–°æ•°ç»„ä¸­çš„ç‰¹å®šå…ƒç´ 
db.users.updateOne(
  { name: "å¼ ä¸‰" },
  { $set: { "hobbies.0": "æ–°çˆ±å¥½" } }
)

// ä½¿ç”¨ä½ç½®æ“ä½œç¬¦ $ æ›´æ–°åŒ¹é…çš„æ•°ç»„å…ƒç´ 
db.users.updateOne(
  { "hobbies": "æ¸¸æ³³" },
  { $set: { "hobbies.$": "æ–°æ¸¸æ³³" } }
)

// ä½¿ç”¨ $[] æ›´æ–°æ‰€æœ‰æ•°ç»„å…ƒç´ 
db.users.updateOne(
  { name: "å¼ ä¸‰" },
  { $set: { "hobbies.$[]": "æ›´æ–°åçš„çˆ±å¥½" } }
)
```

### 6. æ›´æ–°é€‰é¡¹

```javascript
// upsert - å¦‚æœä¸å­˜åœ¨åˆ™æ’å…¥
db.users.updateOne(
  { name: "æ–°ç”¨æˆ·" },
  { $set: { age: 25, city: "åŒ—äº¬" } },
  { upsert: true }
)

// arrayFilters - æ¡ä»¶æ›´æ–°æ•°ç»„å…ƒç´ 
db.users.updateOne(
  { name: "å¼ ä¸‰" },
  { $set: { "scores.$[elem]": 100 } },
  { arrayFilters: [{ "elem": { $gte: 80 } }] }
)
```

## ğŸ—‘ï¸ Delete - åˆ é™¤æ“ä½œ

### 1. åˆ é™¤å•ä¸ªæ–‡æ¡£

```javascript
// ä½¿ç”¨ deleteOne() åˆ é™¤å•ä¸ªæ–‡æ¡£
db.users.deleteOne({ name: "å¼ ä¸‰" })

// è¿”å›ç»“æœ
{
  acknowledged: true,
  deletedCount: 1
}
```

### 2. åˆ é™¤å¤šä¸ªæ–‡æ¡£

```javascript
// ä½¿ç”¨ deleteMany() åˆ é™¤å¤šä¸ªæ–‡æ¡£
db.users.deleteMany({ age: { $lt: 25 } })

// åˆ é™¤æ‰€æœ‰æ–‡æ¡£
db.users.deleteMany({})
```

### 3. åˆ é™¤é›†åˆ

```javascript
// åˆ é™¤æ•´ä¸ªé›†åˆ
db.users.drop()

// åˆ é™¤æ•°æ®åº“
db.dropDatabase()
```

## ğŸ› ï¸ å®è·µç»ƒä¹ 

### ç»ƒä¹ 1ï¼šåŸºç¡€CRUDæ“ä½œ

1. åˆ›å»ºä¸€ä¸ªç”¨æˆ·é›†åˆ
2. æ’å…¥5ä¸ªç”¨æˆ·æ–‡æ¡£
3. æŸ¥è¯¢å¹´é¾„å¤§äº25çš„ç”¨æˆ·
4. æ›´æ–°æ‰€æœ‰ç”¨æˆ·çš„statuså­—æ®µ
5. åˆ é™¤å¹´é¾„å°äº20çš„ç”¨æˆ·

### ç»ƒä¹ 2ï¼šå¤æ‚æŸ¥è¯¢

1. åˆ›å»ºåŒ…å«åµŒå¥—æ–‡æ¡£å’Œæ•°ç»„çš„ç”¨æˆ·æ•°æ®
2. æŸ¥è¯¢ç‰¹å®šåŸå¸‚çš„ç”¨æˆ·
3. æŸ¥è¯¢æœ‰ç‰¹å®šçˆ±å¥½çš„ç”¨æˆ·
4. ä½¿ç”¨æŠ•å½±åªè¿”å›éœ€è¦çš„å­—æ®µ
5. å¯¹ç»“æœè¿›è¡Œæ’åºå’Œåˆ†é¡µ

### ç»ƒä¹ 3ï¼šæ•°ç»„æ“ä½œ

1. åˆ›å»ºåŒ…å«æˆç»©æ•°ç»„çš„å­¦ç”Ÿæ–‡æ¡£
2. å‘æ•°ç»„æ·»åŠ æ–°æˆç»©
3. æ›´æ–°ç‰¹å®šä½ç½®çš„æˆç»©
4. åˆ é™¤ç‰¹å®šæˆç»©
5. æŸ¥è¯¢æˆç»©å¤§äº80çš„å­¦ç”Ÿ

## â“ å¸¸è§é—®é¢˜

### Q: å¦‚ä½•æ‰¹é‡æ’å…¥å¤§é‡æ•°æ®ï¼Ÿ

A: ä½¿ç”¨`insertMany()`æ–¹æ³•ï¼Œå»ºè®®æ¯æ‰¹æ’å…¥1000-5000ä¸ªæ–‡æ¡£ã€‚

### Q: æ›´æ–°æ“ä½œä¼šå½±å“æ€§èƒ½å—ï¼Ÿ

A: æ˜¯çš„ï¼Œé¢‘ç¹æ›´æ–°ä¼šå½±å“æ€§èƒ½ã€‚å»ºè®®åˆç†è®¾è®¡æ–‡æ¡£ç»“æ„ï¼Œå‡å°‘æ›´æ–°æ“ä½œã€‚

### Q: å¦‚ä½•é¿å…é‡å¤æ’å…¥ï¼Ÿ

A: ä½¿ç”¨`upsert: true`é€‰é¡¹ï¼Œæˆ–è€…å…ˆæŸ¥è¯¢å†æ’å…¥ã€‚

### Q: åˆ é™¤æ“ä½œå¯ä»¥æ’¤é”€å—ï¼Ÿ

A: ä¸èƒ½ç›´æ¥æ’¤é”€ï¼Œå»ºè®®å…ˆå¤‡ä»½é‡è¦æ•°æ®ã€‚

### Q: å¦‚ä½•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼Ÿ

A: ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•ï¼Œä½¿ç”¨æŠ•å½±å‡å°‘æ•°æ®ä¼ è¾“ã€‚

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®ä¸€è‡´æ€§** - æ³¨æ„å¹¶å‘æ“ä½œå¯èƒ½å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´
2. **æ€§èƒ½è€ƒè™‘** - å¤§é‡æ•°æ®æ“ä½œæ—¶è€ƒè™‘åˆ†æ‰¹å¤„ç†
3. **ç´¢å¼•å½±å“** - æ›´æ–°æ“ä½œä¼šå½±å“ç´¢å¼•æ€§èƒ½
4. **äº‹åŠ¡æ”¯æŒ** - å¤æ‚æ“ä½œè€ƒè™‘ä½¿ç”¨äº‹åŠ¡
5. **å¤‡ä»½ç­–ç•¥** - é‡è¦æ“ä½œå‰å…ˆå¤‡ä»½æ•°æ®

## ğŸ¯ å­¦ä¹ æ£€æŸ¥

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] æ‰§è¡ŒåŸºæœ¬çš„CRUDæ“ä½œ
- [ ] ä½¿ç”¨å„ç§æŸ¥è¯¢æ¡ä»¶
- [ ] æŒæ¡æ›´æ–°æ“ä½œç¬¦
- [ ] å¤„ç†æ•°ç»„å’ŒåµŒå¥—æ–‡æ¡£
- [ ] ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

---

**ä¸‹ä¸€æ­¥ï¼š** å­¦ä¹  [04-query](./04-query.md) æŸ¥è¯¢æ“ä½œè¯¦è§£
